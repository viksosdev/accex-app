<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbot</title>
    <link rel="stylesheet" href="../styles/bot.css" />
  </head>
  <body>
    <div class="chatbot-container">
      <div class="chatbot-header">
        <span>Chatbot</span>
        <button>X</button>
      </div>
      <div class="chatbot-messages">
        <!-- Mensajes del chatbot y del usuario irán aquí -->
      </div>
      <div class="chatbot-input">
        <textarea placeholder="Introduce un mensaje o una URL..."></textarea>
        <button id="send-btn">Enviar</button>
      </div>
    </div>

    <script>
      const messagesContainer = document.querySelector(".chatbot-messages");
      const inputField = document.querySelector(".chatbot-input textarea");
      const sendButton = document.getElementById("send-btn");
      const closeBtn = document.querySelector(".chatbot-header button");
      let apiURL = null;

      async function initializeApp() {
        try {
          const config = await window.electronAPI.getConfig();

          if (config && config.apiURL) {
            apiURL = config.apiURL;
          } else {
            console.error("No se pudo obtener la configuración de la API");
            displayMessage(
              "No se pudo obtener la configuración de la API. Por favor, intenta de nuevo más tarde.",
              "bot"
            );
          }
        } catch (error) {
          console.error("Error al obtener la configuración de la API:", error);
          displayMessage(
            "No se pudo obtener la configuración de la API. Por favor, intenta de nuevo más tarde.",
            "bot"
          );
        }
      }

      async function sendMessage(message) {
        if (!apiURL) {
          displayMessage(
            "No se pudo obtener la configuración de la API. Por favor, intenta de nuevo más tarde.",
            "bot"
          );
          return;
        }
        try {
          const response = await fetch(`${apiURL}/chat`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ message }),
          });

          const data = await response.json();
          if (data.response) {
            displayMessage(data.response, "bot");
          } else {
            displayMessage(
              "Error al procesar tu mensaje. Por favor, vuelve a preguntarme.",
              "bot"
            );
          }
        } catch (error) {
          console.error("Error:", error);
          displayMessage(
            "Actualmente no me encuentro en linea, intenta escribirme en otro momento",
            "bot"
          );
        }
      }

      function displayMessage(text, sender) {
        const messageElement = document.createElement("div");
        messageElement.className = `message ${sender}`;
        messageElement.textContent = text;
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      sendButton.addEventListener("click", () => {
        const message = inputField.value.trim();
        if (message) {
          displayMessage(message, "user");
          sendMessage(message);
          inputField.value = null;
        }
      });

      inputField.addEventListener("focus", () => {
        window.electronAPI.send("disable-shortcuts");
      });

      inputField.addEventListener("blur", () => {
        window.electronAPI.send("enable-shortcuts");
      });

      closeBtn.addEventListener("click", () => {
        window.electronAPI.send("close-bot");
      });

      inputField.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
          const message = inputField.value.trim();
          if (message) {
            displayMessage(message, "user");
            sendMessage(message);
            inputField.value = "";
          }
        }
      });

      window.onload = () => {
        displayMessage(
          "Soy Accex, un chatbot especializado en analizar sitios web y resumir información clave. Introduce una URL o pregunta.",
          "bot"
        );
      };
      initializeApp();
    </script>
  </body>
</html>
